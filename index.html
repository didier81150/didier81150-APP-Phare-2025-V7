<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Application Collège</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; }
    input, select, button { margin-top: 5px; padding: 6px; width: 100%; max-width: 300px; }
    button { background: #2563eb; color: white; border: none; cursor: pointer; }
    button:hover { background: #1d4ed8; }
    footer { margin-top: 30px; }
  </style>
  <script>
    // --- Configuration initiale ---
    const INITIAL_CONFIG = {
      schoolName: "Collège Exemple",
      initialStudents: `
        test.test 6G1 Test123
      `
    };
    const DEFAULT_LOGO_BASE64 = "";
    let studentsList = [];

    // --- Parse robuste ---
    function parseInitialStudents(studentString) {
      const students = [];
      const lines = studentString
        .split("\n")
        .map(l => l.trim())
        .filter(l => l && !l.startsWith("//"));

      lines.forEach(line => {
        const parts = line.split(/\s+|,/).map(p => p.trim()).filter(Boolean);
        if (parts.length >= 3) {
          const id = parts[0].toLowerCase();
          const clazz = parts[1];
          const temp = parts[2].trim();
          students.push({
            id: id,
            class: clazz,
            tempPassword: temp,
            password: null
          });
        } else {
          console.warn("Ligne élève ignorée (format incorrect) :", line);
        }
      });

      return students;
    }

    // --- Appliquer config initiale ---
    function applyInitialConfiguration() {
      if (INITIAL_CONFIG.schoolName && INITIAL_CONFIG.schoolName !== "Collège [NOM DE VOTRE ÉTABLISSEMENT]") {
        localStorage.setItem("schoolName", INITIAL_CONFIG.schoolName);
      }
      if (DEFAULT_LOGO_BASE64) {
        localStorage.setItem("schoolLogo", DEFAULT_LOGO_BASE64);
      }

      const initialStudentsParsed = parseInitialStudents(INITIAL_CONFIG.initialStudents);
      if (initialStudentsParsed.length > 0) {
        const existing = JSON.parse(localStorage.getItem("studentsList") || "[]");
        initialStudentsParsed.forEach(s => {
          const exists = existing.some(e => e.id === s.id && e.class === s.class);
          if (!exists) existing.push(s);
        });
        studentsList = existing;
        localStorage.setItem("studentsList", JSON.stringify(studentsList));
      }
    }

    // --- Réinitialiser application ---
    function resetApplication() {
      localStorage.clear();
      location.reload();
    }

    // --- Gestion des pages ---
    function showPage(pageId) {
      document.querySelectorAll("section").forEach(sec => sec.style.display = "none");
      document.getElementById(pageId).style.display = "block";
    }

    // --- Connexion élève ---
    function handleStudentLogin(event) {
      event.preventDefault();
      const studentId = document.getElementById("studentId").value.trim().toLowerCase();
      const studentClass = document.getElementById("studentClass").value;
      const tempPassword = document.getElementById("studentTempPassword").value.trim();
      const rememberMe = document.getElementById("rememberMe").checked;

      const studentsList = JSON.parse(localStorage.getItem("studentsList") || "[]");
      const student = studentsList.find(s => s.id === studentId && s.class === studentClass);

      if (!student) {
        alert("Élève non trouvé.");
        return;
      }

      if (!student.password) {
        if (student.tempPassword === tempPassword) {
          const newPassword = prompt("Définissez votre nouveau mot de passe :");
          if (newPassword) {
            student.password = newPassword;
            localStorage.setItem("studentsList", JSON.stringify(studentsList));
            localStorage.setItem("loggedInStudent", JSON.stringify(student));
            showPage("studentPage"); // ✅ Aller à la page élève
          }
        } else {
          alert("Mot de passe provisoire incorrect.");
        }
      } else {
        if (student.password === tempPassword) {
          if (rememberMe) {
            localStorage.setItem("loggedInStudent", JSON.stringify(student));
          }
          showPage("studentPage"); // ✅ Aller à la page élève
        } else {
          alert("Mot de passe incorrect.");
        }
      }
    }

    // --- Initialisation ---
    window.onload = () => {
      if (!localStorage.getItem("appInitialized")) {
        applyInitialConfiguration();
        localStorage.setItem("appInitialized", "true");
      }
      studentsList = JSON.parse(localStorage.getItem("studentsList") || "[]");
      showPage("studentLoginPage"); // page par défaut
    };
  </script>
</head>
<body>
  <h1 id="schoolTitle">Portail Élèves</h1>

  <!-- Connexion Élève -->
  <section id="studentLoginPage">
    <h2>Connexion Élève</h2>
    <form id="studentLoginForm" onsubmit="handleStudentLogin(event)">
      <label for="studentId">Identifiant (nom.prenom)</label>
      <input type="text" id="studentId" required>

      <label for="studentClass">Classe</label>
      <select id="studentClass" required>
        <option value="6G1">6G1</option>
        <option value="6G2">6G2</option>
      </select>

      <label for="studentTempPassword">Mot de passe provisoire ou personnel</label>
      <input type="password" id="studentTempPassword" required>

      <label>
        <input type="checkbox" id="rememberMe"> Se souvenir de moi
      </label>

      <button type="submit">Connexion</button>
    </form>
  </section>

  <!-- Page Élève -->
  <section id="studentPage" style="display:none;">
    <h2>Espace Élève</h2>
    <p>Bienvenue dans votre espace personnel.</p>
    <!-- ici tu peux réutiliser tes formulaires et menus existants -->
  </section>

  <footer>
    <a href="#" onclick="resetApplication()">Réinitialiser l'application (pour test)</a>
  </footer>
</body>
</html>
